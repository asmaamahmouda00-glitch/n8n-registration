name: Run WorldPosta Automation

on:
  workflow_dispatch:  # Allows n8n to trigger it via HTTP request

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repo
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Install dependencies for Chrome
      # -----------------------------
      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2t64 \
            libnss3 \
            libxss1 \
            libappindicator3-1 \
            libindicator3-7 \
            fonts-liberation


      # -----------------------------
      # 3. Install Google Chrome (LATEST linux build)
      # -----------------------------
      - name: Install Google Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt --fix-broken install -y

      # -----------------------------
      # 4. Install matching ChromeDriver
      # -----------------------------
      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | sed 's/Google Chrome //')
          echo "Detected Chrome version: $CHROME_VERSION"

          LATEST_CHROMEDRIVER=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
          echo "Installing ChromeDriver version: $LATEST_CHROMEDRIVER"

          wget https://chromedriver.storage.googleapis.com/${LATEST_CHROMEDRIVER}/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      # -----------------------------
      # 5. Setup Python
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # 6. Install Python dependencies
      # -----------------------------
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install selenium beautifulsoup4 undetected-chromedriver || true
          pip install -r requirements.txt || true

      # -----------------------------
      # 7. Run your automation script
      # -----------------------------
      - name: Run automation script
        env:
          DISPLAY: ":99"
        run: |
          # Start a virtual display for headless mode
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          
          echo "Running automation script..."
          python worldposta_automation_complete.py
          # -----------------------------
      # 8. DEBUG ‚Äî Show screenshot directory
      # -----------------------------
      - name: Show screenshots folder (debug)
        run: |
          echo "üìÅ Listing repository root:"
          ls -R .
          echo "üìÅ Listing screenshots directory:"
          ls -R screenshots || echo "‚ö†Ô∏è screenshots directory does not exist!"

      # -----------------------------
      # 9. Upload screenshots as artifact
      # -----------------------------
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/**
          if-no-files-found: warn
